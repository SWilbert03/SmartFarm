{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr">
  
<head>
  <meta charset="utf-8">
  <title>Smart Farm</title> 
  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>

</head>

<body>
	<table border="1">
		<th colspan="4">Corn</th>
		<tr>
			<th>Soil Moisture Sensor</th>
			<th>Air Temperature Sensor</th>
			<th>Light Intensity Sensor</th>
			<th>Automatic Irrigation</th>
		</tr>
		<tr>
			<td><span id="SoilMoistureSensor"></span>%</td>
			<td><span id="AirTemperatureSensor"></span>&#176;C</td>
			<td><span id="LightIntensitySensor"></span> lux</td>
			<td><span id="AutomaticIrrigation"></span> minute</td>
		</tr>
		<tr>
			<td colspan="4"><canvas id="actuatorChart"></canvas></td>
		</tr>

	</table>
	
</body>

<script>
  function updateSensorValue(endpoint, id) {
    $.ajax({
      method: "GET",
      url: endpoint,
      success: function(data) {
          var value = document.getElementById(id);
          value.innerHTML = data.value;
      },
      error: function(error_data) {
          console.log(error_data);
      }
    })
  }

  function updateActuatorState(endpoint, id) {
    $.ajax({
      method: "GET",
      url: endpoint,
      success: function(data) {
          var state = document.getElementById(id);
          state.innerHTML = data.state;
      },
      error: function(error_data) {
          console.log(error_data);
      }
    })
  }

//==
  var actuatorChart = new Chart(document.getElementById("actuatorChart"), {
	type: 'line',
	data: {
		labels: [],
		datasets: [{
		label: "Automatic Irrigation",
		data: [],
		borderColor: "#3e95cd",
		fill: false
		}]
	},
	options: {
		responsive: true,
		title: {
		display: true,
		text: 'Automatic Irrigation Chart'
		},
		scales: {
		xAxes: [{
			display: true
		}],
		yAxes: [{
			display: true,
			ticks: {
			suggestedMin: 0,
			suggestedMax: 15
			}
		}]
		}
	}
  });

  function updateActuatorChart(endpoint) {
  	$.ajax({
    method: "GET",
    url: endpoint,
    success: function(data) {
	  actuatorChart.data.labels.push(new Date().toLocaleTimeString());
      actuatorChart.data.datasets[0].data.push(data.state);
      
      // hapus data lama jika data sudah mencapai 7
      if (actuatorChart.data.labels.length > 7) {
        actuatorChart.data.labels.shift();
        actuatorChart.data.datasets[0].data.shift();
      }
      
      actuatorChart.update();
    },
    error: function(error_data) {
      console.log(error_data);
    }
    })
  }
  
  setInterval(function(){
	
    updateSensorValue('/smartfarm/soilmoisture', 'SoilMoistureSensor');
    updateSensorValue('/smartfarm/airtemperature', 'AirTemperatureSensor');
    updateSensorValue('/smartfarm/lightintensity', 'LightIntensitySensor');
    updateActuatorState('/actuator/automaticirrigation', 'AutomaticIrrigation');
	updateActuatorChart('/actuator/automaticirrigation');

  }, 1000);

</script>